<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Expenses | Expense Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f6f8;
            padding: 20px;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filters input, .filters select {
            padding: 8px 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        button {
            padding: 8px 14px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
        }
        button:hover {
            background-color: #0056b3;
        }
        .clear-btn {
            background-color: #6c757d;
        }
        .clear-btn:hover {
            background-color: #5a6268;
        }
        .logout-btn {
            background-color: #dc3545;
        }
        .logout-btn:hover {
            background-color: #c82333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        th {
            background-color: #007bff;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #e9ecef;
        }
        .top-actions {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            align-items: center;
        }
        .summary {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .summary-item {
            flex: 1;
            min-width: 150px;
        }
        .summary-item h3 {
            margin: 0;
            color: #666;
            font-size: 14px;
        }
        .summary-item p {
            margin: 5px 0 0 0;
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
    </style>
</head>
<body>

<h1>Expense Tracker</h1>

<div class="top-actions">
    <div>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
    <div>
        <button onclick="goToLogExpense()">+ Log New Expense</button>
    </div>
</div>

<div class="error-message" id="errorMessage"></div>

<div class="summary" id="summary">
    <div class="summary-item">
        <h3>Total Expenses</h3>
        <p id="totalExpenses">₹0.00</p>
    </div>
    <div class="summary-item">
        <h3>Number of Transactions</h3>
        <p id="totalCount">0</p>
    </div>
</div>

<div class="filters">
    <input type="date" id="startDate" placeholder="Start Date" />
    <input type="date" id="endDate" placeholder="End Date" />

    <select id="category">
        <option value="">All Categories</option>
        <option value="Rent/Housing">Rent/Housing</option>
        <option value="Medical">Medical</option>
        <option value="Fitness">Fitness</option>
        <option value="Loans/Debt">Loans/Debt</option>
        <option value="Food">Food</option>
        <option value="Beverages">Beverages</option>
        <option value="Dine Out">Dine Out</option>
        <option value="Groceries">Groceries</option>
        <option value="Travel">Travel</option>
        <option value="Fuel">Fuel</option>
        <option value="Investing">Investing</option>
        <option value="Education">Education</option>
        <option value="Entertainment">Entertainment</option>
        <option value="Personal Care">Personal Care</option>
        <option value="Clothing/Footwear">Clothing/Footwear</option>
        <option value="Electronics">Electronics</option>
        <option value="Alcohol">Alcohol</option>
        <option value="Cigarettes">Cigarettes</option>
        <option value="Gifts/Donations">Gifts/Donations</option>
        <option value="Taxes">Taxes</option>
        <option value="Subscriptions">Subscriptions</option>
        <option value="Utilities">Utilities</option>
        <option value="Insurance">Insurance</option>
        <option value="Others">Others</option>
    </select>

    <select id="paymentMethod">
        <option value="">All Payment Methods</option>
        <option value="Cash">Cash</option>
        <option value="Credit Card">Credit Card</option>
        <option value="Debit Card">Debit Card</option>
        <option value="UPI">UPI</option>
        <option value="Net Banking">Net Banking</option>
        <option value="Other">Other</option>
    </select>

    <select id="expenseType">
        <option value="">All Expense Types</option>
        <option value="Needs">Needs</option>
        <option value="Wants">Wants</option>
        <option value="Investments">Investments</option>
    </select>

    <button onclick="applyFilters()">Apply Filters</button>
    <button class="clear-btn" onclick="clearFilters()">Clear Filters</button>
</div>

<table id="expensesTable">
    <thead>
    <tr>
        <th>Date</th>
        <th>Amount (₹)</th>
        <th>Category</th>
        <th>Payment Method</th>
        <th>Bank Account</th>
        <th>Expense Type</th>
        <th>Description</th>
        <th>Location</th>
        <th>Actions</th> <!-- New column -->
    </tr>
    </thead>
    <tbody>
    <!-- Expenses will be populated here -->
    </tbody>
</table>

<script>
    const email = localStorage.getItem("email");
    if (!email) {
        alert("No logged-in user found!");
        window.location.href = "UserLogin.html";
    }

    function showError(message) {
        const errorDiv = document.getElementById("errorMessage");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
        setTimeout(() => { errorDiv.style.display = "none"; }, 5000);
    }

    async function fetchExpenses(filters = {}) {
        const params = new URLSearchParams();
        if (filters.startDate) params.append('startDate', filters.startDate);
        if (filters.endDate) params.append('endDate', filters.endDate);
        if (filters.category) params.append('category', filters.category);
        if (filters.paymentMethod) params.append('paymentMethod', filters.paymentMethod);
        if (filters.expenseType) params.append('expenseType', filters.expenseType);

        const queryString = params.toString();
        const url = `http://localhost:8080/api/expenses/list/${encodeURIComponent(email)}${queryString ? '?' + queryString : ''}`;

        console.log('Fetching from URL:', url);

        try {
            const response = await fetch(url, { method: 'GET', headers: { 'Content-Type': 'application/json' } });
            console.log('Response status:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Error response:', errorText);
                throw new Error(`Failed to fetch expenses: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            populateTable(data);
            updateSummary(data);
        } catch (error) {
            console.error('Fetch error:', error);
            showError(`Error fetching expenses: ${error.message}`);
        }
    }

    function populateTable(expenses) {
        const tbody = document.querySelector("#expensesTable tbody");
        tbody.innerHTML = "";

        if (!expenses || expenses.length === 0) {
            tbody.innerHTML = `<tr><td colspan="9">No expenses found</td></tr>`;
            return;
        }

        expenses.forEach(exp => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${exp.date || '-'}</td>
                <td>₹${(exp.amount || 0).toFixed(2)}</td>
                <td>${exp.category || '-'}</td>
                <td>${exp.paymentMethod || '-'}</td>
                <td>${exp.bankAccount || '-'}</td>
                <td>${exp.expenseType || '-'}</td>
                <td>${exp.description || '-'}</td>
                <td>${exp.location || '-'}</td>
                <td>
                    <button onclick="editExpense(${exp.id})">Edit</button>
                    <button onclick="deleteExpense(${exp.id})" style="background-color:#dc3545;color:white;">Delete</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateSummary(expenses) {
        if (!expenses || expenses.length === 0) {
            document.getElementById("totalExpenses").textContent = "₹0.00";
            document.getElementById("totalCount").textContent = "0";
            return;
        }

        const total = expenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
        const count = expenses.length;

        document.getElementById("totalExpenses").textContent = `₹${total.toFixed(2)}`;
        document.getElementById("totalCount").textContent = count;
    }

    function applyFilters() {
        const filters = {
            startDate: document.getElementById("startDate").value || null,
            endDate: document.getElementById("endDate").value || null,
            category: document.getElementById("category").value || null,
            paymentMethod: document.getElementById("paymentMethod").value || null,
            expenseType: document.getElementById("expenseType").value || null
        };
        Object.keys(filters).forEach(key => { if (!filters[key]) delete filters[key]; });
        fetchExpenses(filters);
    }

    function clearFilters() {
        document.getElementById("startDate").value = "";
        document.getElementById("endDate").value = "";
        document.getElementById("category").value = "";
        document.getElementById("paymentMethod").value = "";
        document.getElementById("expenseType").value = "";
        fetchExpenses();
    }

    function logout() {
        localStorage.removeItem("email");
        localStorage.removeItem("firstName");
        window.location.href = "UserLogin.html";
    }

    function goToLogExpense() {
        window.location.href = "LogExpense.html";
    }

    function editExpense(expenseId) {
        window.location.href = `LogExpense.html?id=${expenseId}`;
    }

    function deleteExpense(expenseId) {
        const confirmDelete = confirm("Are you sure you want to delete this expense?");
        if (!confirmDelete) return;

        //alert("Delete functionality for Expense ID: " + expenseId + " will be implemented later.");
        // Later: call backend API
        fetch(`http://localhost:8080/api/expenses/${expenseId}`, { method: 'DELETE' })
              .then(() => fetchExpenses());
    }

    // Fetch default (current month) expenses on page load
    fetchExpenses();
</script>

</body>
</html>
