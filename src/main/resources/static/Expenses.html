<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Expenses | Expense Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .header h1 {
            font-size: 28px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header-actions {
            display: flex;
            gap: 10px;
        }
        button {
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            background-color: #667eea;
            color: white;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a8b 100%);
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        .content {
            padding: 30px;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid #dc3545;
        }
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            border-radius: 10px;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: transform 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-5px);
        }
        .summary-card h3 {
            font-size: 14px;
            font-weight: 500;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .summary-card p {
            font-size: 32px;
            font-weight: 700;
        }
        .filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            align-items: end;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #495057;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .filters input, .filters select {
            padding: 10px 12px;
            font-size: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            background: white;
            transition: border-color 0.3s ease;
        }
        .filters input:focus, .filters select:focus {
            outline: none;
            border-color: #667eea;
        }
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            user-select: none;
            white-space: nowrap;
        }
        th.sortable {
            cursor: pointer;
            padding-right: 30px;
        }
        th.sortable:hover {
            background: linear-gradient(135deg, #5568d3 0%, #653a8b 100%);
        }
        th.sortable::after {
            content: '‚áÖ';
            position: absolute;
            right: 10px;
            opacity: 0.5;
            font-size: 14px;
        }
        th.sort-asc::after {
            content: '‚Üë';
            opacity: 1;
        }
        th.sort-desc::after {
            content: '‚Üì';
            opacity: 1;
        }
        td {
            padding: 15px 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
            color: #495057;
        }
        tbody tr {
            transition: all 0.2s ease;
        }
        tbody tr:hover {
            background-color: #f8f9fa;
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        tr:last-child td {
            border-bottom: none;
        }
        .date-cell {
            font-weight: 500;
            color: #495057;
            white-space: nowrap;
        }
        .date-primary {
            display: block;
            font-size: 15px;
            font-weight: 600;
            color: #2c3e50;
        }
        .date-secondary {
            display: block;
            font-size: 12px;
            color: #6c757d;
            margin-top: 2px;
        }
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        .action-buttons button {
            padding: 6px 12px;
            font-size: 12px;
        }
        .amount-cell {
            font-weight: 600;
            color: #dc3545;
        }
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge-needs {
            background-color: #ffc107;
            color: #000;
        }
        .badge-wants {
            background-color: #17a2b8;
            color: white;
        }
        .badge-investments {
            background-color: #28a745;
            color: white;
        }
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            font-size: 16px;
        }
        .category-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .category-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .description-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .location-cell {
            color: #6c757d;
            font-size: 13px;
        }
        @media (max-width: 768px) {
            .header h1 {
                font-size: 22px;
            }
            .summary {
                grid-template-columns: 1fr;
            }
            .filters {
                grid-template-columns: 1fr;
            }
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üí∞ Expense Tracker</h1>
        <div class="header-actions">
            <button class="btn-success" onclick="goToHome()">Home</button>
            <button class="btn-success" onclick="goToLogExpense()">Log New Expense</button>
            <button class="btn-danger" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="content">
        <div class="error-message" id="errorMessage"></div>

        <div class="summary">
            <div class="summary-card">
                <h3>Total Expenses</h3>
                <p id="totalExpenses">‚Çπ0.00</p>
            </div>
            <div class="summary-card">
                <h3>Transactions</h3>
                <p id="totalCount">0</p>
            </div>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label>Search Description</label>
                <input type="text" id="searchDescription" placeholder="Search by description..." />
            </div>
            <div class="filter-group">
                <label>Start Date</label>
                <input type="date" id="startDate" />
            </div>
            <div class="filter-group">
                <label>End Date</label>
                <input type="date" id="endDate" />
            </div>
            <div class="filter-group">
                <label>Category</label>
                <select id="category">
                    <option value="">üìä All Categories</option>
                    <option value="Rent/Housing">üè† Rent/Housing</option>
                    <option value="Medical">üè• Medical</option>
                    <option value="Fitness">üí™ Fitness</option>
                    <option value="Loans/Debt">üí≥ Loans/Debt</option>
                    <option value="Food">üçî Food</option>
                    <option value="Beverages">‚òï Beverages</option>
                    <option value="Dine Out">üçΩÔ∏è Dine Out</option>
                    <option value="Groceries">üõí Groceries</option>
                    <option value="Travel">‚úàÔ∏è Travel</option>
                    <option value="Fuel">‚õΩ Fuel</option>
                    <option value="Investing">üìà Investing</option>
                    <option value="Education">üìö Education</option>
                    <option value="Entertainment">üé¨ Entertainment</option>
                    <option value="Personal Care">üíÖ Personal Care</option>
                    <option value="Clothing/Footwear">üëï Clothing/Footwear</option>
                    <option value="Electronics">üì± Electronics</option>
                    <option value="Alcohol">üç∫ Alcohol</option>
                    <option value="Cigarettes">üö¨ Cigarettes</option>
                    <option value="Gifts/Donations">üéÅ Gifts/Donations</option>
                    <option value="Taxes">üßæ Taxes</option>
                    <option value="Subscriptions">üì∫ Subscriptions</option>
                    <option value="Utilities">üí° Utilities</option>
                    <option value="Insurance">üõ°Ô∏è Insurance</option>
                    <option value="Trips">üó∫Ô∏è Trips</option>
                    <option value="Others">üì¶ Others</option>F
                </select>
            </div>
            <div class="filter-group">
                <label>Payment Method</label>
                <select id="paymentMethod">
                    <option value="">All Methods</option>
                    <option value="Cash">Cash</option>
                    <option value="Credit Card">Credit Card</option>
                    <option value="Debit Card">Debit Card</option>
                    <option value="UPI">UPI</option>
                    <option value="Net Banking">Net Banking</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Expense Type</label>
                <select id="expenseType">
                    <option value="">All Types</option>
                    <option value="Needs">Needs</option>
                    <option value="Wants">Wants</option>
                    <option value="Investments">Investments</option>
                </select>
            </div>
            <button class="btn-primary" onclick="applyFilters()">Apply Filters</button>
            <button class="btn-secondary" onclick="clearFilters()">Clear Filters</button>
        </div>

        <div class="table-container">
            <table id="expensesTable">
                <thead>
                <tr>
                    <th class="sortable" onclick="sortTable('date')">Date</th>
                    <th class="sortable" onclick="sortTable('amount')">Amount (‚Çπ)</th>
                    <th>Category</th>
                    <th>Payment Method</th>
                    <th>Bank Account</th>
                    <th>Expense Type</th>
                    <th>Description</th>
                    <th>Location</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const email = localStorage.getItem("email");
    if (!email) {
        alert("No logged-in user found!");
        window.location.href = "UserLogin.html";
    }

    let currentExpenses = [];
    let currentSort = { column: 'date', direction: 'desc' };

    // --- Set default date range with conditional logic ---
    const today = new Date();
    const lastDayCurrentMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    let start, end;

    if (today.getDate() === lastDayCurrentMonth.getDate()) {
        start = new Date(today);
        const lastDayNextMonth = new Date(today.getFullYear(), today.getMonth() + 2, 0);
        end = new Date(lastDayNextMonth);
        end.setDate(end.getDate() - 1);
    } else {
        start = new Date(today.getFullYear(), today.getMonth(), 0);
        end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        end.setDate(end.getDate() - 1);
    }

    function formatDateForInput(d) {
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Set startDate and endDate inputs
    document.getElementById("startDate").value = formatDateForInput(start);
    document.getElementById("endDate").value = formatDateForInput(end);

    // Date formatting for table display
    function formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        const day = date.getDate();
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                            "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const month = monthNames[date.getMonth()];
        const year = String(date.getFullYear()).slice(-2);
        return `${day} ${month} ${year}`;
    }

    // Enhanced showError function with success message support
    function showError(message) {
        const errorDiv = document.getElementById("errorMessage");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";

        // Change styling for success messages
        if (message.includes('successfully')) {
            errorDiv.style.backgroundColor = "#d4edda";
            errorDiv.style.color = "#155724";
            errorDiv.style.borderLeftColor = "#28a745";
        } else {
            errorDiv.style.backgroundColor = "#f8d7da";
            errorDiv.style.color = "#721c24";
            errorDiv.style.borderLeftColor = "#dc3545";
        }

        setTimeout(() => {
            errorDiv.style.display = "none";
            // Reset to default error styling
            errorDiv.style.backgroundColor = "#f8d7da";
            errorDiv.style.color = "#721c24";
            errorDiv.style.borderLeftColor = "#dc3545";
        }, 3000);
    }

    async function fetchExpenses(filters = {}) {
        const params = new URLSearchParams();
        params.append('startDate', filters.startDate || document.getElementById("startDate").value);
        params.append('endDate', filters.endDate || document.getElementById("endDate").value);
        if (filters.category) params.append('category', filters.category);
        if (filters.paymentMethod) params.append('paymentMethod', filters.paymentMethod);
        if (filters.expenseType) params.append('expenseType', filters.expenseType);

        const queryString = params.toString();
        const url = `http://localhost:8080/api/expenses/list/${encodeURIComponent(email)}${queryString ? '?' + queryString : ''}`;

        try {
            const response = await fetch(url, { method: 'GET', headers: { 'Content-Type': 'application/json' } });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Failed to fetch expenses: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            currentExpenses = data;

            if (filters.searchDescription) {
                const searchTerm = filters.searchDescription.toLowerCase();
                currentExpenses = currentExpenses.filter(exp =>
                    (exp.description || '').toLowerCase().includes(searchTerm)
                );
            }

            sortExpenses();
            populateTable(currentExpenses);
            updateSummary(currentExpenses);
        } catch (error) {
            showError(`Error fetching expenses: ${error.message}`);
        }
    }

    function sortTable(column) {
        if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.direction = column === 'date' ? 'desc' : 'asc';
        }
        sortExpenses();
        populateTable(currentExpenses);
        updateSortIndicators();
    }

    function sortExpenses() {
        currentExpenses.sort((a, b) => {
            let aVal, bVal;

            if (currentSort.column === 'amount') {
                aVal = a.amount || 0;
                bVal = b.amount || 0;
            } else if (currentSort.column === 'date') {
                aVal = new Date(a.date || 0);
                bVal = new Date(b.date || 0);
            }

            if (currentSort.direction === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });
    }

    function updateSortIndicators() {
        document.querySelectorAll('th.sortable').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
        });

        const sortedHeader = document.querySelector(`th.sortable[onclick*="${currentSort.column}"]`);
        if (sortedHeader) {
            sortedHeader.classList.add(`sort-${currentSort.direction}`);
        }
    }

    function populateTable(expenses) {
        const tbody = document.querySelector("#expensesTable tbody");
        tbody.innerHTML = "";

        if (!expenses || expenses.length === 0) {
            tbody.innerHTML = `<tr><td colspan="9" class="no-data">üì≠ No expenses found</td></tr>`;
            return;
        }

        expenses.forEach(exp => {
            const tr = document.createElement("tr");
            const badgeClass = exp.expenseType === 'Needs' ? 'badge-needs' :
                              exp.expenseType === 'Wants' ? 'badge-wants' : 'badge-investments';

            tr.innerHTML = `
                <td class="date-cell">${formatDate(exp.date)}</td>
                <td class="amount-cell">‚Çπ${(exp.amount || 0).toFixed(2)}</td>
                <td>${exp.category || '-'}</td>
                <td>${exp.paymentMethod || '-'}</td>
                <td>${exp.bankAccount || '-'}</td>
                <td><span class="badge ${badgeClass}">${exp.expenseType || '-'}</span></td>
                <td>${exp.description || '-'}</td>
                <td>${exp.location || '-'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-primary" onclick="editExpense(${exp.id})">Edit</button>
                        <button class="btn-danger" onclick="deleteExpense(${exp.id})">Delete</button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateSummary(expenses) {
        if (!expenses || expenses.length === 0) {
            document.getElementById("totalExpenses").textContent = "‚Çπ0.00";
            document.getElementById("totalCount").textContent = "0";
            return;
        }

        const total = expenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
        const count = expenses.length;

        document.getElementById("totalExpenses").textContent = `‚Çπ${total.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        document.getElementById("totalCount").textContent = count.toLocaleString('en-IN');
    }

    function applyFilters() {
        const filters = {
            searchDescription: document.getElementById("searchDescription").value || null,
            startDate: document.getElementById("startDate").value || null,
            endDate: document.getElementById("endDate").value || null,
            category: document.getElementById("category").value || null,
            paymentMethod: document.getElementById("paymentMethod").value || null,
            expenseType: document.getElementById("expenseType").value || null
        };
        Object.keys(filters).forEach(key => { if (!filters[key]) delete filters[key]; });
        fetchExpenses(filters);
    }

    function clearFilters() {
        document.getElementById("searchDescription").value = "";
        document.getElementById("startDate").value = formatDateForInput(start);
        document.getElementById("endDate").value = formatDateForInput(end);
        document.getElementById("category").value = "";
        document.getElementById("paymentMethod").value = "";
        document.getElementById("expenseType").value = "";
        currentSort = { column: 'date', direction: 'desc' };
        fetchExpenses();
    }

    // Edit Expense Function
    function editExpense(expenseId) {
        window.location.href = `LogExpense.html?id=${expenseId}`;
    }

    // Delete Expense Function
    async function deleteExpense(expenseId) {
        if (!confirm('Are you sure you want to delete this expense?')) {
            return;
        }

        try {
            const response = await fetch(`http://localhost:8080/api/expenses/${expenseId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            });

            if (!response.ok) {
                throw new Error(`Failed to delete expense: ${response.status}`);
            }

            // Show success message
            showError('Expense deleted successfully!');

            // Reload the expenses
            fetchExpenses({
                searchDescription: document.getElementById("searchDescription").value || null,
                startDate: document.getElementById("startDate").value || null,
                endDate: document.getElementById("endDate").value || null,
                category: document.getElementById("category").value || null,
                paymentMethod: document.getElementById("paymentMethod").value || null,
                expenseType: document.getElementById("expenseType").value || null
            });
        } catch (error) {
            showError(`Error deleting expense: ${error.message}`);
        }
    }

    function goToLogExpense() {
        window.location.href = "LogExpense.html";
    }

    function goToHome() {
        window.location.href = "Home.html";
    }

    function logout() {
        if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem("firstName");
            localStorage.removeItem("email");
            window.location.href = "UserLogin.html";
        }
    }

    // Initial fetch with default date range
    fetchExpenses();
    updateSortIndicators();
</script>




</body>
</html>